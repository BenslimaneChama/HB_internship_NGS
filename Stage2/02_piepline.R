# ===============================
# 1. Load required libraries
# ===============================
library(DESeq2)
library(pheatmap)
library(ggplot2)

# ===============================
# 2. Import count data and metadata
# ===============================
# Read counts file (generated by featureCounts)
fc <- read.delim("gene_counts.txt", comment.char = "#", check.names = FALSE)
head(fc)

# Load counts and metadata (new version with Group: FBD, SBD, FHC, SHC)
c_e_count <- read.delim('gene_counts.txt', header = T)
c_e_meta <- read.delim('metadata.tsv', header = T, stringsAsFactors = T)

# Quick preview of input data
head(c_e_count)
head(c_e_meta)

# ===============================
# 3. Prepare count matrix
# ===============================
# Keep only relevant columns: Gene IDs + sample counts
raw_counts <- fc[, c("Geneid", grep("^SRR", colnames(fc), value = TRUE))]
head(raw_counts)

# Set gene IDs as rownames
rownames(raw_counts) <- c_e_count$Geneid
raw_counts <- raw_counts[ , -1]  # remove Geneid column
head(raw_counts)

# ===============================
# 4. Create DESeq2 dataset object
# ===============================
dds <- DESeqDataSetFromMatrix(countData = raw_counts,
                              colData = c_e_meta,
                              design = ~ Age + Group)

# Preview metadata inside DESeq2 object
dds
dds$SRA.Accession.Number
dds$Age
dds$Group   

# Set reference group (here: SHC = sporadic healthy control)
dds$Group <- relevel(dds$Group, ref = "SHC")

# ===============================
# 5. Run DESeq2 pipeline
# ===============================
dds <- DESeq(dds)

# ===============================
# 6. PCA analysis (sample clustering)
# ===============================
vsd <- vst(dds, blind = TRUE)
pcaData <- plotPCA(vsd, intgroup = c("Group", "Age"), returnData = TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))

ggplot(pcaData, aes(PC1, PC2, color = Group, shape = Group, size = Age)) +
  geom_point(alpha = 0.8) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  ggtitle("PCA of RNA-seq samples by Group") +
  scale_size_continuous(range = c(3,6)) +
  theme_minimal()

# ===============================
# 7. Differential expression analyses
# ===============================
# Three contrasts of interest:
res_SBDvsSHC <- results(dds, contrast = c("Group", "SBD", "SHC"), alpha = 0.05)
res_FBDvsFHC <- results(dds, contrast = c("Group", "FBD", "FHC"), alpha = 0.05)
res_SBDvsFBD <- results(dds, contrast = c("Group", "SBD", "FBD"), alpha = 0.05)

# summary 
summary(res_SBDvsSHC)
sum(res_SBDvsSHC$padj < 0.05, na.rm = TRUE)
sum(res_FBDvsFHC$padj < 0.05, na.rm = TRUE)
sum(res_SBDvsFBD$padj < 0.05, na.rm = TRUE)
# ===============================
# 8. Volcano plot function
# ===============================
plot_volcano <- function(res, title){
  plot(x = res$log2FoldChange, 
       y = -log10(res$pvalue), 
       cex = 0.25, pch = 19, col = 'grey',
       ylab = '-log10(p-value)',
       xlab = 'Log2 Fold Change')
  abline(v = c(-1, 1), lty = 2)  
  abline(h = -log10(0.05), lty = 2)  
  up <- subset(res, padj < 0.05 & log2FoldChange > 1)
  down <- subset(res, padj < 0.05 & log2FoldChange < -1)
  points(up$log2FoldChange, -log10(up$pvalue), col = "red", pch = 19)
  points(down$log2FoldChange, -log10(down$pvalue), col = "blue", pch = 19)
  mtext(title)
}

# Volcano plots for each comparison
plot_volcano(res_SBDvsSHC, "SBD vs SHC")
plot_volcano(res_FBDvsFHC, "FBD vs FHC")
plot_volcano(res_SBDvsFBD, "SBD vs FBD")

# ===============================
# 9. Heatmap of DEGs
# ===============================
# Heatmap
vsd <- vst(dds, blind = FALSE)
mat <- assay(vsd)

sel <- with(as.data.frame(res_SBDvsSHC),
            which(!is.na(padj) & padj < 0.05 & abs(log2FoldChange) > 1))

if (length(sel) < 30) {
  v <- rowVars(mat)
  sel <- head(order(v, decreasing = TRUE), 300)
}

mat_sub <- mat[sel, ]
mat_sub <- t(scale(t(mat_sub)))  # z-score

ann_col <- as.data.frame(colData(dds)[, c("Group","Age")])
ann_colors <- list(
  Group = c(SBD = "tomato", FBD = "orange", SHC = "steelblue", FHC = "skyblue")
)

pheatmap(mat_sub,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         show_rownames = FALSE,
         annotation_col = ann_col,
         annotation_colors = ann_colors,
         fontsize_col = 10,
         scale = "none")

# ===============================
# 10. Export gene lists for enrichment
# ===============================
write.csv(rownames(subset(res_SBDvsSHC, padj < 0.05 & abs(log2FoldChange) > 1)), "genes_SBDvsSHC.csv")
write.csv(rownames(subset(res_FBDvsFHC, padj < 0.05 & abs(log2FoldChange) > 1)), "genes_FBDvsFHC.csv")
write.csv(rownames(subset(res_SBDvsFBD, padj < 0.05 & abs(log2FoldChange) > 1)), "genes_SBDvsFBD.csv")

# Next step: upload these gene lists to ShinyGO / Reactome / GSEA
